# Sprint 03 — Invite Flow & Deck Mechanics

**Sprint Duration:** 1-2 weeks
**Sprint Goal:** Implement host invite flow, session lobby, Google Places integration, and swipeable card UI
**Epic Focus:** E-04 (Host Invite & Session Management - UI), E-05 (Deck Fetch & Swipe Mechanics)
**Owner:** Claude (Code Implementor)
**PM:** Codex

---

## Sprint Objectives

1. Build invite flow UI with shareable link and lobby states
2. Implement session lifecycle and timeout handling
3. Integrate Google Places API for deck generation
4. Create swipeable card UI with animations

---

## Sprint Backlog

### S-402 — Invite Flow UI & Lobby States
- **Epic:** E-04
- **Priority:** P0 (Launch Blocking)
- **Status:** Planned
- **Estimated Effort:** 12-16 hours
- **Dependencies:** S-203 (Auth Gate), S-401 (Session Backend)

**Goal:** Host sees invite modal with shareable link or Twilio-powered SMS send. Pending state indicates "Waiting for guest…"; updates when guest joins. Guest deep link routes to lobby post-login with status copy.

**Acceptance Criteria:**
- [ ] **Host Invite Modal:**
  - Opens when "Invite" button tapped
  - Displays host info: profile placeholder, display name (storyboard lines 110-115)
  - Shows unique join link (generated by S-401)
  - Provides "Copy Link" button
  - Guest phone number field uses E.164 validation and masks (Twilio SMS channel)
  - "Invite!" button sends invite (via share sheet or Twilio SMS if phone provided)
  - Close button returns to home
- [ ] **Host Waiting State:**
  - After invite sent, show lobby screen
  - Display "Waiting for guest…" message (storyboard lines 124-126)
  - Show host and guest slots (guest shows "pending")
  - Real-time update when guest joins
  - Display "X has joined!" notification
  - "Start Browse" button appears after guest joins
- [ ] **Guest Join Flow:**
  - Guest opens invite link → Authenticates (S-203) → Enters lobby
  - Lobby shows host name and own name
  - Waiting message: "Waiting for host to start…" or similar
  - When host taps "Start Browse", both navigate to swipe deck
- [ ] **Lobby Sync:**
  - Polling or WebSocket (prefer polling for MVP simplicity)
  - Poll interval: 2 seconds
  - Update lobby state when session changes

**Technical Notes:**
- Share link using Expo Sharing API: `Sharing.shareAsync()`
- Invite URL format: `https://nightswipe.app/join/{join_code}`
- Twilio SMS: backend will call Twilio Messaging Service with dynamic link; configure env (`TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_MESSAGING_SERVICE_SID`)
- Copy link: Use Expo Clipboard: `Clipboard.setStringAsync()`
- Real-time lobby updates:
  - Option 1: Polling `GET /session/:id` every 2 seconds
  - Option 2: WebSocket (more complex, defer if time constrained)
- Navigation: Use React Navigation to route between Home → Invite → Lobby → Deck
- Handle edge case: Guest joins but host has closed app (show error)

**UI Components:**
- InviteModal
- LobbyScreen (host variant)
- LobbyScreen (guest variant)
- UserSlot component (shows user or "pending")

**Deliverables:**
- Invite modal component
- Lobby screen (host and guest variants)
- Share/copy link functionality
- Lobby polling logic
- Navigation flow
- Manual test: Host invites, guest joins, both see updates

---

### S-403 — Session Lifecycle & Timeout Handling
- **Epic:** E-04
- **Priority:** P1 (MVP Differentiator)
- **Status:** Planned
- **Estimated Effort:** 8-12 hours
- **Dependencies:** S-401 (Session Backend)

**Goal:** Idle sessions auto-expire after configurable timeout. Host can cancel invite, clearing guest state. Rejoin logic handles reconnecting guests gracefully.

**Acceptance Criteria:**
- [ ] **Session Timeout:**
  - Backend expires sessions after 30 minutes of inactivity (configurable)
  - Expired sessions return 410 Gone on join attempts
  - Frontend polls detect expired sessions and show error: "This session has expired"
  - User returns to home screen
- [ ] **Host Cancel Invite:**
  - Host lobby has "Cancel" button
  - Canceling sets session status to "cancelled"
  - Guest is notified: "Host has cancelled this session"
  - Both users return to home
- [ ] **Guest Disconnect/Rejoin:**
  - Guest closes app while in lobby → Can rejoin using same link
  - GET /session/:id returns existing membership
  - Guest re-enters lobby seamlessly
  - Host sees guest status update
- [ ] **Error Handling:**
  - Network errors during lobby polling → Show retry message
  - Session full (3+ users somehow) → Error message
  - Graceful degradation for all error states

**Technical Notes:**
- Backend: Use cron job or scheduled task to mark expired sessions
- Session expiry logic:
  ```sql
  UPDATE sessions
  SET status = 'expired'
  WHERE status = 'pending'
  AND created_at < NOW() - INTERVAL '30 minutes';
  ```
- Frontend: Check session status in polling response
- Host cancel: `PATCH /session/:id` with `{ "status": "cancelled" }`
- Guest rejoin: Check `session_members` table for existing membership

**API Endpoint Updates:**
```
PATCH /session/:id
Headers: Authorization: Bearer <token>
Request Body:
{
  "status": "cancelled"  // or other status updates
}

Response (200 OK):
{
  "session_id": string,
  "status": "cancelled"
}

Error Responses:
- 403: Only host can cancel
- 410: Session already expired
```

**Deliverables:**
- Backend session expiry logic
- Cancel invite endpoint
- Frontend cancel button and flow
- Rejoin logic
- Error state UI components
- Unit tests for timeout scenarios

---

### S-501 — Places Fetch & Normalization
- **Epic:** E-05
- **Priority:** P0 (Launch Blocking)
- **Status:** Planned
- **Estimated Effort:** 12-16 hours
- **Dependencies:** S-302 (Location), S-401 (Session)

**Goal:** Fetch 20–25 places (restaurants/bars/activities) using Google Places API near host coordinates. Normalize payload: name, photo, category, rating, review count, address, distance. Persist deck seed & raw results for reuse.

**Acceptance Criteria:**
- [ ] **Backend Endpoint:** `POST /session/:id/deck`
- [ ] Fetch places using Google Places Nearby Search API
- [ ] Search parameters:
  - Location: host coordinates from session
  - Radius: 5000 meters (5km) - configurable
  - Types: `restaurant`, `bar`, `night_club`, `cafe` (MVP scope)
  - Rank by: `prominence` (Google's default)
  - Min results: 20, Max: 25
- [ ] Handle pagination if needed to reach 20+ results
- [ ] **Normalize place data:**
  - `place_id` (Google's unique ID)
  - `name`
  - `photo_url` (primary photo, fallback to placeholder if none)
  - `category` (map types to: "Restaurant", "Bar", "Activity")
  - `rating` (1-5 stars, null if unavailable)
  - `review_count` (user_ratings_total)
  - `address` (vicinity or formatted_address)
  - `distance` (calculated from host location in meters/km)
- [ ] **Deck Seed:**
  - Generate unique seed per session: `${lat}_${lng}_${timestamp}`
  - Store seed in session record
  - Shuffle places deterministically using seed (same order for both users)
- [ ] **Caching (Optional for MVP):**
  - Cache results in `places_cache` table keyed by `(lat, lng, seed)`
  - TTL: 1 hour
  - Avoids redundant API calls
- [ ] **Error Handling:**
  - No results found → Expand radius to 10km and retry once
  - API quota exceeded → Return friendly error
  - Invalid coordinates → 400 error

**Technical Notes:**
- Google Places API key stored in `.env`
- Use Nearby Search endpoint: `https://maps.googleapis.com/maps/api/place/nearbysearch/json`
- Request example:
  ```
  GET https://maps.googleapis.com/maps/api/place/nearbysearch/json
    ?location=40.7128,-74.0060
    &radius=5000
    &type=restaurant|bar|night_club
    &key=YOUR_API_KEY
  ```
- Photo URL construction: `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference={photo_ref}&key={api_key}`
- Distance calculation: Haversine formula (or use turf.js)
- Deterministic shuffle: Seed-based shuffle (e.g., seedrandom library)
- Document API quota limits (NightSwipe quota planning)

**API Endpoint Spec:**
```
POST /session/:id/deck
Headers: Authorization: Bearer <token>

Response (200 OK):
{
  "session_id": string,
  "deck": [
    {
      "place_id": string,
      "name": string,
      "photo_url": string,
      "category": string,
      "rating": number | null,
      "review_count": number,
      "address": string,
      "distance_km": number,
      "order": number  // 0-indexed position in deck
    },
    ...
  ],
  "deck_seed": string,
  "total_count": number
}

Error Responses:
- 404: No places found (after retry)
- 429: API quota exceeded
- 500: Google API error
```

**Deliverables:**
- Backend deck generation endpoint
- Google Places API integration
- Data normalization logic
- Deck seed and shuffling
- Distance calculation
- Error handling
- API quota monitoring plan
- Unit tests
- API documentation

---

### S-502 — Swipeable Card UI & Animations
- **Epic:** E-05
- **Priority:** P0 (Launch Blocking)
- **Status:** Planned
- **Estimated Effort:** 16-20 hours
- **Dependencies:** S-501 (Places Fetch)

**Goal:** Implement swipe left/right gestures with visual feedback per storyboard. Track swipe order locally for latency mitigation. Provide accessible alternative (buttons) if gesture fails.

**Acceptance Criteria:**
- [ ] **Card Stack UI:**
  - Display deck of place cards (data from S-501)
  - Show top card prominently, stack 2-3 behind with offset/scale effect
  - Card displays: photo, name, category, rating, address, distance
- [ ] **Swipe Gestures:**
  - Swipe left → Dismiss (no interest)
  - Swipe right → Like (interested)
  - Visual feedback: card tilts in swipe direction
  - On release:
    - Past threshold → Card flies off screen, next card animates forward
    - Below threshold → Card springs back to center
  - Threshold: 40% of screen width
- [ ] **Visual Indicators:**
  - Swipe left: Red overlay with "X" icon fades in
  - Swipe right: Green overlay with "♥" icon fades in
  - Opacity scales with swipe distance
- [ ] **Button Fallback:**
  - Bottom of screen: "✗" (left) and "♥" (right) buttons
  - Tap buttons to swipe programmatically
  - Same animation as gesture
- [ ] **Progress Indicator:**
  - Show card count: "3 / 25" at top
  - Update as user swipes
- [ ] **End of Deck:**
  - After last card swiped, show transition screen or auto-navigate
  - For solo: Check if quota met (handled in S-601)
  - For two-user: Show "Waiting for other user…"
- [ ] **Performance:**
  - Animations run at 60fps on both platforms
  - No jank or lag during swipe
  - Use native driver where possible

**Technical Notes:**
- Use React Native Reanimated 2 or Animated API
- Gesture handler: `react-native-gesture-handler` PanGestureHandler
- Card component structure:
  - Background image (place photo)
  - Gradient overlay for text readability
  - Text: name, category, rating/reviews, address, distance
- Swipe animation:
  - TranslateX based on gesture
  - Rotate: `interpolate(translateX, [-300, 0, 300], [-15, 0, 15])`
  - Overlay opacity: `interpolate(translateX, [0, 100], [0, 1])`
- Stack effect: Translate/scale next 2-3 cards
- Animation timing: 300ms spring animation for snap back / fly off
- Accessibility: Buttons must be keyboard/screenreader accessible

**UI Design Reference:**
- Storyboard lines 157-204 for card layout
- Photo should be prominent (60-70% of card)
- Info section at bottom (40-30% of card)
- Card aspect ratio: ~3:4 (portrait)

**Deliverables:**
- PlaceCard component
- CardStack component with gesture handling
- Swipe animation logic
- Visual overlays (left/right indicators)
- Button fallback controls
- Progress counter
- Manual test on iOS and Android
- Performance profiling

---

## Sprint Success Metrics

- [ ] All P0 items (S-402, S-501, S-502) completed and tested
- [ ] P1 item (S-403) completed or backlog for next sprint
- [ ] Host can invite guest and see lobby states
- [ ] Google Places API successfully fetches and normalizes deck
- [ ] Swipeable card UI works smoothly on both platforms
- [ ] Code passes linter with no errors

---

## Testing Checklist

### Manual Testing

**Invite Flow (S-402):**
- [ ] Host taps "Invite" → Modal opens with join link
- [ ] Copy link button → Link copied to clipboard
- [ ] Share button → Opens share sheet (iOS/Android)
- [ ] Host in lobby → See "Waiting for guest…"
- [ ] Guest opens link → Authenticates → Enters lobby
- [ ] Host lobby updates when guest joins
- [ ] "Start Browse" appears after guest joins
- [ ] Both navigate to deck when host taps "Start Browse"

**Session Lifecycle (S-403):**
- [ ] Session expires after 30 min → Error shown
- [ ] Host cancels invite → Guest notified
- [ ] Guest closes app and reopens link → Rejoins lobby
- [ ] Network error during polling → Retry message shown

**Places Fetch (S-501):**
- [ ] POST /session/:id/deck → Returns 20-25 places
- [ ] Places include all required fields
- [ ] Deck seed is deterministic (same order for both users)
- [ ] No results found → Retry with larger radius
- [ ] API quota exceeded → Friendly error
- [ ] Test with various locations (urban, suburban, rural)

**Swipeable Cards (S-502):**
- [ ] Deck displays with card stack effect
- [ ] Swipe left → Card flies off left, next card appears
- [ ] Swipe right → Card flies off right, next card appears
- [ ] Swipe halfway and release → Card springs back
- [ ] Visual overlays (X/♥) appear based on swipe direction
- [ ] Button taps animate same as gestures
- [ ] Progress counter updates (e.g., "5 / 25")
- [ ] Last card swiped → Transition to waiting/results
- [ ] Performance: 60fps on iPhone 12 and mid-range Android

---

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Google Places API quota exceeded | Medium | High | Monitor usage, implement caching, request quota increase |
| Swipe animation performance issues | Medium | Medium | Use native driver, optimize renders, test on low-end devices |
| No places found in rural areas | Medium | Low | Expand radius to 10km+ on retry, show helpful message |
| Lobby polling creates server load | Low | Medium | Use reasonable interval (2s), consider WebSocket for scale |

---

## Definition of Done

- All acceptance criteria met for S-402, S-403, S-501, S-502
- Code committed to feature branch
- Linter passes with no errors
- Google Places API integrated and tested
- Swipe gestures work on iOS and Android
- API documentation updated
- Restart Brief updated with session summary
- Check-in log sent to Codex (PM)

---

## Next Sprint Preview

**Sprint 04** will focus on:
- Swipe submission & sync (S-503)
- Solo results & match screen (S-601)
- Host/Guest match logic & load more loop (S-602)

---

**End of Sprint 03 Plan**
