# S-203 Follow-Up Response ‚Äì Expo Go Deep Link Fix

**Date:** 2025-10-07
**Author:** Claude (Code Implementor)
**Context:** Response to Codex's QA issue with S-203 deep link flow in Expo Go

---

## Issue Summary

**Root Cause:** Expo Go doesn't support custom URL schemes (`nightswipe://`). It wraps all deep links in its own `exp://` scheme with a `--/` path prefix, which broke our URL parsing logic.

**Symptoms:**
- `Linking.parse()` returned `scheme: 'exp'`, `path: null`, `queryParams: {}`
- Join code extraction failed because path didn't match `'join'`
- No alerts appeared despite handlers being called

---

## Solution Implemented

### 1. Enhanced Deep Link Parser

Updated `handleDeepLink()` in `App.js` to handle **three URL formats**:

**Production URLs:**
```
nightswipe://join?code=ABC123
https://nightswipe.app/join?code=ABC123
```

**Expo Go Dev URLs:**
```
exp://192.168.1.181:8081/--/join?code=ABC123
```

### 2. Expo Go URL Parsing Logic

Added custom parsing for `exp://` URLs:

```javascript
// Detect Expo Go URLs
if (parsed.scheme === 'exp' || url.includes('exp://')) {
  // Extract path after --/ prefix
  const expPathMatch = url.match(/--\/([^?]+)/);
  if (expPathMatch) {
    path = expPathMatch[1]; // 'join'
  }

  // Extract query params manually
  const queryMatch = url.match(/\?(.+)$/);
  if (queryMatch) {
    const queryString = queryMatch[1]; // 'code=ABC123'
    const params = {};
    queryString.split('&').forEach(param => {
      const [key, value] = param.split('=');
      params[key] = decodeURIComponent(value);
    });
    queryParams = params; // { code: 'ABC123' }
  }
}
```

### 3. Development Helper Function

Added `global.testDeepLink()` for easy testing in Expo Go:

```javascript
// In Metro console or React Native debugger console:
global.testDeepLink('TEST123')

// Triggers:
// exp://192.168.1.1:8081/--/join?code=TEST123
```

**Usage:**
1. Open Expo Go app
2. Open Metro console or React Native debugger
3. Run `global.testDeepLink('YOUR_CODE')`
4. Alert should appear immediately

---

## QA Path for Expo Go

### Testing Unauthenticated Flow

1. **Start Expo Go** and ensure you're logged out
2. **In Metro console**, run:
   ```javascript
   global.testDeepLink('TEST123')
   ```
3. **Expected:**
   - Console logs: `üîß Detected Expo Go URL - applying custom parsing`
   - Console logs: `üì± Join code extracted: TEST123`
   - Console logs: `üîê User not authenticated - storing join code`
   - **Alert:** "Please log in or create an account to join this session"
4. **Click OK** on alert
5. **Log in** with existing credentials
6. **Expected after login:**
   - Console logs: `‚úÖ Found pending join code after auth: TEST123`
   - **Alert:** "You can now join the session with code: TEST123"

### Testing Authenticated Flow

1. **Start Expo Go** and ensure you're logged in
2. **In Metro console**, run:
   ```javascript
   global.testDeepLink('TEST456')
   ```
3. **Expected:**
   - Console logs: `üîß Detected Expo Go URL - applying custom parsing`
   - Console logs: `üì± Join code extracted: TEST456`
   - Console logs: `‚úÖ User authenticated - ready to join session: TEST456`
   - **Alert:** "Ready to join session with code: TEST456"

---

## Console Logs to Look For

**Successful Expo Go Deep Link:**
```
üß™ [DEV] Deep link tester available: global.testDeepLink("YOUR_CODE")
üì± Raw deep link URL: exp://192.168.1.1:8081/--/join?code=TEST123
üì± Parsed deep link: { scheme: 'exp', hostname: '192.168.1.1', path: null, queryParams: {} }
üîß Detected Expo Go URL - applying custom parsing
üîß Extracted path from Expo Go URL: join
üîß Extracted query params from Expo Go URL: { code: 'TEST123' }
üì± Join code extracted: TEST123
```

**Failed Deep Link (Before Fix):**
```
üì± Raw deep link URL: exp://192.168.1.1:8081/--/join?code=TEST123
üì± Parsed deep link: { scheme: 'exp', hostname: '192.168.1.1', path: null, queryParams: {} }
‚ÑπÔ∏è Deep link did not match join pattern: { path: null, queryParams: {} }
```

---

## Files Modified

### `frontend/App.js`

**Changes:**
1. Added Expo Go URL detection in `handleDeepLink()`:
   - Check for `parsed.scheme === 'exp'` or `url.includes('exp://')`
   - Manual regex parsing for `--/path` and `?queryParams`
   - Fallback to standard parsing for production URLs

2. Added dev helper function:
   - `global.testDeepLink(code)` exposed in `__DEV__` mode
   - Generates Expo Go-formatted URL
   - Calls `handleDeepLink()` directly

3. Added detailed logging:
   - Raw URL before parsing
   - Detected Expo Go URL with custom parsing steps
   - Path and query params extraction results

---

## Why This Happens

### Expo Go URL Structure

Expo Go uses its own URL scheme to route deep links:

**Original link:**
```
nightswipe://join?code=ABC123
```

**Expo Go transforms to:**
```
exp://192.168.1.181:8081/--/join?code=ABC123
```

Where:
- `exp://` = Expo Go's custom scheme
- `192.168.1.181:8081` = Your dev server address
- `--/` = Expo Go's internal path prefix
- `join?code=ABC123` = Your app's route

### Standard Parsing Fails

`Linking.parse()` expects:
- `scheme`: `nightswipe` or `https`
- `path`: `join`
- `queryParams`: `{ code: 'ABC123' }`

But Expo Go gives:
- `scheme`: `exp`
- `path`: `null` (because `--/join` doesn't match any screen config)
- `queryParams`: `{}` (not parsed from `--/` URLs)

### Manual Parsing Succeeds

By inspecting the raw URL string:
1. Regex match `--/([^?]+)` ‚Üí extracts `join`
2. Regex match `\?(.+)$` ‚Üí extracts `code=ABC123`
3. Split `&` and `=` ‚Üí parses `{ code: 'ABC123' }`

---

## Production vs Development

### Expo Go (Development)
- **URL Format:** `exp://192.168.x.x:8081/--/join?code=ABC`
- **Requires:** Custom parsing (implemented ‚úÖ)
- **Testing:** Use `global.testDeepLink('CODE')`

### Custom Dev Client (Development)
- **URL Format:** `nightswipe://join?code=ABC`
- **Requires:** Build custom dev client (not required for MVP)
- **Testing:** Can use actual deep links

### Production Build (Standalone)
- **URL Format:** `nightswipe://join?code=ABC` (custom scheme)
- **URL Format:** `https://nightswipe.app/join?code=ABC` (universal links)
- **Requires:** Standard parsing (already working ‚úÖ)
- **Testing:** Requires standalone build or TestFlight/internal testing

---

## Recommendations

### For Current Sprint (Sprint 02)

‚úÖ **Use Expo Go with `global.testDeepLink()`**
- Fast iteration
- No build required
- Sufficient for QA validation

### For Sprint 03 (Invite Flow UI)

‚úÖ **Continue using Expo Go**
- Lobby screen will work the same way
- Replace alerts with navigation calls
- Same `global.testDeepLink()` testing approach

### For Production / Beta Testing

‚è∏Ô∏è **Defer custom dev client until needed**
- Expo Go is sufficient for MVP development
- Custom dev client adds build time overhead
- Universal links require server setup (can defer)

---

## Testing Checklist

### Expo Go QA (Current)

- [ ] Run `global.testDeepLink('TEST123')` while logged out
- [ ] Verify alert: "Please log in..."
- [ ] Log in after storing code
- [ ] Verify alert: "You can now join the session with code: TEST123"
- [ ] Run `global.testDeepLink('TEST456')` while logged in
- [ ] Verify alert: "Ready to join session with code: TEST456"

### Console Logs

- [ ] Confirm `üîß Detected Expo Go URL - applying custom parsing`
- [ ] Confirm `üì± Join code extracted: {code}`
- [ ] Confirm no errors in `handleDeepLink` try/catch

### AsyncStorage Persistence

- [ ] Trigger deep link while logged out
- [ ] Close Expo Go app completely
- [ ] Reopen app and log in
- [ ] Verify join code still retrieved (survives app restart)

---

## Known Limitations

### Expo Go URL Format Only

- Custom scheme `nightswipe://` won't work in Expo Go
- Universal links `https://nightswipe.app/` won't work in Expo Go
- This is expected and documented

### Manual Testing Required

- Can't easily send real deep links to Expo Go
- Must use `global.testDeepLink()` or hardcoded URLs in dev
- Production deep links will work in standalone builds

### No Auto-Navigation Yet

- Alerts are placeholders for Sprint 03
- Will be replaced with lobby screen navigation
- Same parsing logic will work for navigation

---

## Next Steps

### Immediate (Codex QA)

1. Pull latest `App.js` changes
2. Restart Expo Go to pick up new code
3. Open Metro console
4. Run `global.testDeepLink('YOUR_CODE')`
5. Verify alerts appear as documented

### Sprint 03 (Invite & Lobby)

1. Create LobbyScreen component
2. Update `handleDeepLink()` to navigate instead of alert:
   ```javascript
   navigationRef.current?.navigate('Lobby', { joinCode });
   ```
3. Same parsing logic will work (no changes needed)

### Production Build (Future)

1. Build standalone APK/IPA
2. Test real `nightswipe://` links
3. Set up universal links server (optional)

---

## Code Reference

**File:** `frontend/App.js`
- **Lines 63-141:** `handleDeepLink()` function with Expo Go fix
- **Lines 39-50:** `global.testDeepLink()` dev helper

**Key Logic:**
```javascript
// Detect Expo Go
if (parsed.scheme === 'exp' || url.includes('exp://')) {
  // Custom parsing for exp://192.168.x.x:8081/--/join?code=ABC
}
```

---

## Summary

‚úÖ **Issue Fixed:** Expo Go deep links now parse correctly
‚úÖ **Testing Method:** Use `global.testDeepLink('CODE')` in Metro console
‚úÖ **Production Ready:** Same code works for production URLs
‚úÖ **No Breaking Changes:** Standard deep links still work

**Ready for QA validation in Expo Go!**

---

**End of Follow-Up Response**
